<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HackerSpace Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #0f172a, #581c87, #0f172a);
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto p-6">
        <div class="bg-slate-800/50 backdrop-blur-sm rounded-lg shadow-2xl p-8 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-4xl font-bold text-white mb-2">HackerSpace</h1>
                    <p class="text-slate-300">Posts by kman2140</p>
                </div>
                <button id="refreshBtn" class="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <svg id="refreshIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
            <p id="lastUpdate" class="text-sm text-slate-400"></p>

            <!-- Loading: PROGRESS BAR -->
            <div id="loading" class="mt-4">
                <div class="w-full max-w-md">
                    <div class="flex justify-between mb-2">
                        <span class="text-slate-200 text-sm">Loading posts...</span>
                        <span id="loadingPercent" class="text-slate-400 text-xs">0%</span>
                    </div>
                    <div class="w-full h-3 bg-slate-900/60 rounded-full overflow-hidden">
                        <div id="loadingBar"
                             class="h-full bg-purple-500 rounded-full transition-all duration-200"
                             style="width: 0%;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error -->
            <div id="error" class="hidden mt-4 text-red-400 text-sm"></div>

            <!-- Posts grid -->
            <div id="posts" class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>

            <!-- Load more -->
            <div id="loadMoreContainer" class="mt-6 text-center hidden">
                <button id="loadMoreBtn"
                        class="px-4 py-2 text-sm bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                    Load more
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { SimplePool, nip19 } from 'https://esm.sh/nostr-tools@2.10.2';

        const RELAYS = [
            'wss://relay.damus.io',
            'wss://relay.nostr.band',
            'wss://nos.lol',
            'wss://relay.primal.net',
            'wss://nostr.wine',
            'wss://relay.snort.social'
        ];

        // same NPUB you had before
        const NPUB = 'npub1cyla8qgt9gv8y6ydv8s2prt89h8afc0sr2kaz64ryjmlpdrzxm4qwlh53q';

        const pool = new SimplePool();
        const POSTS_PER_PAGE = 9;

        let allPosts = [];
        let displayedPosts = [];
        let hexPubkey;
        let loadingInterval;

        // Decode npub to hex
        try {
            const decoded = nip19.decode(NPUB);
            hexPubkey = decoded.data;
            console.log('âœ“ Converted npub to hex:', hexPubkey);
        } catch (e) {
            console.error('Error decoding npub:', e);
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = 'Error: Invalid npub format';
            errorDiv.classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        /* -------------------------
         * Progress bar functions
         * ------------------------- */
        function startLoadingBar() {
            const loadingDiv  = document.getElementById('loading');
            const bar         = document.getElementById('loadingBar');
            const percentText = document.getElementById('loadingPercent');

            if (!loadingDiv || !bar || !percentText) return;

            loadingDiv.classList.remove('hidden');

            let progress = 0;
            bar.style.width = '0%';
            percentText.textContent = '0%';

            if (loadingInterval) clearInterval(loadingInterval);

            loadingInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 10;
                    if (progress > 90) progress = 90;
                    bar.style.width = `${progress}%`;
                    percentText.textContent = `${Math.round(progress)}%`;
                }
            }, 200);
        }

        function finishLoadingBar() {
            const loadingDiv  = document.getElementById('loading');
            const bar         = document.getElementById('loadingBar');
            const percentText = document.getElementById('loadingPercent');

            if (!loadingDiv || !bar || !percentText) return;

            clearInterval(loadingInterval);
            bar.style.width = '100%';
            percentText.textContent = '100%';

            setTimeout(() => {
                loadingDiv.classList.add('hidden');
            }, 300);
        }

        /* -------------------------
         * Helpers
         * ------------------------- */
        function formatDate(timestamp) {
            return new Date(timestamp * 1000).toLocaleString();
        }

        function extractImages(content) {
            const imageRegex = /(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp))/gi;
            return content.match(imageRegex) || [];
        }

        function formatContent(content) {
            // Remove image URLs from text since we'll display them separately
            let text = content.replace(/(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp))/gi, '');

            return text
                .replace(/https?:\/\/[^\s]+/g, url => `<a href="${url}" target="_blank" class="text-blue-400 hover:underline break-all">${url}</a>`)
                .replace(/#\w+/g, tag => `<span class="text-purple-400">${tag}</span>`)
                .replace(/\n/g, '<br>');
        }

        function filterPostsByHashtag(posts) {
            return posts.filter(post => {
                const content = (post.content || '').toLowerCase();
                return content.includes('hackerspace') || content.includes('boneohackerspace');
            });
        }

        function updateLastUpdate() {
            const el = document.getElementById('lastUpdate');
            if (!el) return;
            const now = new Date().toLocaleString();
            el.textContent = `Last updated: ${now} â€“ Showing ${displayedPosts.length} of ${allPosts.length} posts`;
        }

        function renderPosts() {
            const postsContainer = document.getElementById('posts');
            postsContainer.innerHTML = displayedPosts.map(post => {
                const images = extractImages(post.content || '');
                const formattedText = formatContent(post.content || '');

                return `
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-lg overflow-hidden hover:shadow-xl transition-shadow flex flex-col">
                        ${images.length > 0 ? `
                            <div class="relative w-full aspect-square bg-slate-900">
                                <img src="${images[0]}" alt="Post image"
                                     class="w-full h-full object-cover"
                                     onerror="this.parentElement.style.display='none'">
                            </div>
                        ` : ''}
                        <div class="p-4 flex-1 flex flex-col">
                            <div class="text-xs text-slate-400 mb-3">
                                ${formatDate(post.created_at)}
                            </div>
                            <div class="text-slate-100 text-sm whitespace-pre-wrap break-words flex-1">
                                ${formattedText}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateLoadMoreVisibility() {
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (allPosts.length > displayedPosts.length) {
                loadMoreContainer.classList.remove('hidden');
            } else {
                loadMoreContainer.classList.add('hidden');
            }
        }

        /* -------------------------
         * Fetch posts
         * ------------------------- */
        async function fetchPosts() {
            if (!hexPubkey) return;

            const refreshIcon = document.getElementById('refreshIcon');
            const errorDiv    = document.getElementById('error');

            refreshIcon.classList.add('animate-spin');
            errorDiv.classList.add('hidden');
            allPosts = [];
            displayedPosts = [];

            startLoadingBar();
            console.log('ðŸ“¡ Fetching posts from relays...');

            try {
                const events = await pool.querySync(RELAYS, {
                    authors: [hexPubkey],
                    kinds: [1],
                    limit: 500
                });

                console.log(`âœ“ Received ${events.length} total posts`);

                const filtered = filterPostsByHashtag(events);
                console.log(`âœ“ Filtered to ${filtered.length} #hackerspace / #boneohackerspace posts`);

                filtered.sort((a, b) => b.created_at - a.created_at);

                allPosts = filtered;
                displayedPosts = allPosts.slice(0, POSTS_PER_PAGE);

                renderPosts();
                updateLoadMoreVisibility();
                updateLastUpdate();
            } catch (err) {
                console.error('Error fetching posts:', err);
                errorDiv.textContent = 'Failed to load posts.';
                errorDiv.classList.remove('hidden');
            } finally {
                refreshIcon.classList.remove('animate-spin');
                finishLoadingBar();
            }
        }

        /* -------------------------
         * Event listeners
         * ------------------------- */
        document.getElementById('refreshBtn').addEventListener('click', fetchPosts);

        document.getElementById('loadMoreBtn').addEventListener('click', () => {
            const currentLength = displayedPosts.length;
            const nextBatch = allPosts.slice(0, currentLength + POSTS_PER_PAGE);
            displayedPosts = nextBatch;
            renderPosts();
            updateLoadMoreVisibility();
            updateLastUpdate();
        });

        // Initial fetch + auto-refresh
        if (hexPubkey) {
            fetchPosts();
            setInterval(fetchPosts, 60000);
        }
    </script>
</body>
</html>
