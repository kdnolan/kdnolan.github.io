<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HackerSpace Feed</title>
    <link rel="icon" type="image/png" href="https://kdnolan.com/assets/images/photo-20160315-8003902-90x73.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #0f172a, #581c87, #0f172a);
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto p-6">
        <div class="bg-slate-800/50 backdrop-blur-sm rounded-lg shadow-2xl p-8 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-4xl font-bold text-white mb-2">HackerSpace</h1>
                    <p class="text-slate-300">Posts by kman2140</p>
                </div>
                <button id="refreshBtn" class="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <svg id="refreshIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
            <p id="lastUpdate" class="text-sm text-slate-400"></p>

            <!-- Loading: PROGRESS BAR -->
            <div id="loading" class="mt-4">
                <div class="w-full max-w-md">
                    <div class="flex justify-between mb-2">
                        <span class="text-slate-200 text-sm">Loading posts...</span>
                        <span id="loadingPercent" class="text-slate-400 text-xs">0%</span>
                    </div>
                    <div class="w-full h-3 bg-slate-900/60 rounded-full overflow-hidden">
                        <div id="loadingBar"
                             class="h-full bg-purple-500 rounded-full transition-all duration-200"
                             style="width: 0%;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error -->
            <div id="error" class="hidden mt-4 text-red-400 text-sm"></div>

            <!-- Posts grid -->
            <div id="posts" class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>

            <!-- Load more -->
            <div id="loadMoreContainer" class="mt-6 text-center hidden">
                <button id="loadMoreBtn"
                        class="px-4 py-2 text-sm bg-slate-700 hover:bg-slate-600 text-white rounded-lg">
                    Load more
                </button>
            </div>
        </div>
    </div>

    <!-- Scroll to top button -->
    <button id="scrollToTop" 
            class="fixed bottom-8 right-8 bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-full shadow-lg transition-all opacity-0 pointer-events-none">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
        </svg>
    </button>

    <script type="module">
        import { SimplePool, nip19 } from 'https://esm.sh/nostr-tools@2.10.2';

        const RELAYS = [
            'wss://relay.damus.io',
            'wss://relay.nostr.band',
            'wss://nos.lol',
            'wss://relay.primal.net',
            'wss://nostr.wine',
            'wss://relay.snort.social'
        ];

        // same NPUB you had before
        const NPUB = 'npub1cyla8qgt9gv8y6ydv8s2prt89h8afc0sr2kaz64ryjmlpdrzxm4qwlh53q';

        const pool = new SimplePool();
        const POSTS_PER_PAGE = 9;

        let allPosts = [];
        let displayedPosts = [];
        let hexPubkey;
        let loadingInterval;
        let allArticles = [];

        // Decode npub to hex
        try {
            const decoded = nip19.decode(NPUB);
            hexPubkey = decoded.data;
            console.log('âœ“ Converted npub to hex:', hexPubkey);
        } catch (e) {
            console.error('Error decoding npub:', e);
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = 'Error: Invalid npub format';
            errorDiv.classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        /* -------------------------
         * Progress bar functions
         * ------------------------- */
        function startLoadingBar() {
            const loadingDiv  = document.getElementById('loading');
            const bar         = document.getElementById('loadingBar');
            const percentText = document.getElementById('loadingPercent');

            if (!loadingDiv || !bar || !percentText) return;

            loadingDiv.classList.remove('hidden');

            let progress = 0;
            bar.style.width = '0%';
            percentText.textContent = '0%';

            if (loadingInterval) clearInterval(loadingInterval);

            loadingInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 10;
                    if (progress > 90) progress = 90;
                    bar.style.width = `${progress}%`;
                    percentText.textContent = `${Math.round(progress)}%`;
                }
            }, 200);
        }

        function finishLoadingBar() {
            const loadingDiv  = document.getElementById('loading');
            const bar         = document.getElementById('loadingBar');
            const percentText = document.getElementById('loadingPercent');

            if (!loadingDiv || !bar || !percentText) return;

            clearInterval(loadingInterval);
            bar.style.width = '100%';
            percentText.textContent = '100%';

            setTimeout(() => {
                loadingDiv.classList.add('hidden');
            }, 300);
        }

        /* -------------------------
         * Helpers
         * ------------------------- */
        function formatDate(timestamp) {
            return new Date(timestamp * 1000).toLocaleString();
        }

        function extractImages(content) {
            const imageRegex = /(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp))/gi;
            return content.match(imageRegex) || [];
        }

        function extractImagesFromTags(tags) {
            // Extract images from tags array (used in kind 30023 events)
            const images = [];
            if (Array.isArray(tags)) {
                tags.forEach(tag => {
                    if (Array.isArray(tag) && tag[0] === 'image' && tag[1]) {
                        images.push(tag[1]);
                    }
                });
            }
            return images;
        }

        function formatContent(content) {
            // Remove image URLs from text since we'll display them separately
            let text = content.replace(/(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp))/gi, '');

            return text
                .replace(/https?:\/\/[^\s]+/g, url => `<a href="${url}" target="_blank" class="text-blue-400 hover:underline break-all">${url}</a>`)
                .replace(/#\w+/g, tag => `<span class="text-purple-400">${tag}</span>`)
                .replace(/\n/g, '<br>');
        }

        function filterPostsByHashtag(posts) {
            return posts.filter(post => {
                const content = (post.content || '').toLowerCase();
                const hasHashtag = content.includes('hackerspace') || content.includes('boneohackerspace');
                
                // Check for images in content or tags
                const contentImages = extractImages(post.content || '').length > 0;
                const tagImages = extractImagesFromTags(post.tags).length > 0;
                const hasImages = contentImages || tagImages;
                
                return hasHashtag && hasImages;
            });
        }

        function filterArticlesByHashtag(articles) {
            return articles.filter(article => {
                // Check hashtags in tags array
                let hasHashtag = false;
                if (Array.isArray(article.tags)) {
                    hasHashtag = article.tags.some(tag => {
                        if (Array.isArray(tag) && tag[0] === 't') {
                            const hashtag = (tag[1] || '').toLowerCase();
                            return hashtag === 'hackerspace' || hashtag === 'boneohackerspace';
                        }
                        return false;
                    });
                }
                
                // Also check content
                if (!hasHashtag) {
                    const content = (article.content || '').toLowerCase();
                    hasHashtag = content.includes('hackerspace') || content.includes('boneohackerspace');
                }
                
                // Check for images
                const contentImages = extractImages(article.content || '').length > 0;
                const tagImages = extractImagesFromTags(article.tags).length > 0;
                const hasImages = contentImages || tagImages;
                
                return hasHashtag && hasImages;
            });
        }

        function updateLastUpdate() {
            const el = document.getElementById('lastUpdate');
            if (!el) return;
            const now = new Date().toLocaleString();
            const articleCount = allArticles.length;
            const postCount = allPosts.length - articleCount;
            el.textContent = `Last updated: ${now} â€” Showing ${displayedPosts.length} of ${allPosts.length} items (${postCount} posts, ${articleCount} articles)`;
        }

        function renderPosts() {
            const postsContainer = document.getElementById('posts');
            postsContainer.innerHTML = displayedPosts.map(post => {
                const isArticle = post.kind === 30023;
                let images = extractImages(post.content || '');
                const tagImages = extractImagesFromTags(post.tags);
                
                // Combine images from content and tags
                if (tagImages.length > 0) {
                    images = [...images, ...tagImages];
                }
                
                const formattedText = formatContent(post.content || '');
                
                // Get article title if it's a long-form article
                let title = '';
                if (isArticle && Array.isArray(post.tags)) {
                    const titleTag = post.tags.find(tag => Array.isArray(tag) && tag[0] === 'title');
                    if (titleTag && titleTag[1]) {
                        title = titleTag[1];
                    }
                }
                
                // Generate links
                let postLink = '';
                if (isArticle) {
                    // Generate naddr for articles using nip19
                    const dTag = post.tags?.find(tag => Array.isArray(tag) && tag[0] === 'd');
                    if (dTag && dTag[1]) {
                        try {
                            const naddr = nip19.naddrEncode({
                                kind: 30023,
                                pubkey: post.pubkey,
                                identifier: dTag[1]
                            });
                            postLink = `https://habla.news/a/${naddr}`;
                        } catch (e) {
                            console.error('Error encoding naddr:', e);
                        }
                    }
                } else {
                    // Generate note link for regular posts
                    try {
                        const noteId = nip19.noteEncode(post.id);
                        postLink = `https://primal.net/e/${noteId}`;
                    } catch (e) {
                        console.error('Error encoding note:', e);
                    }
                }

                return `
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-lg overflow-hidden hover:shadow-xl transition-shadow flex flex-col">
                        ${images.length > 0 ? `
                            <div class="relative w-full aspect-square bg-slate-900">
                                <img src="${images[0]}" alt="Post image"
                                     class="w-full h-full object-cover"
                                     onerror="this.parentElement.style.display='none'">
                            </div>
                        ` : ''}
                        <div class="p-4 flex-1 flex flex-col">
                            ${isArticle ? `
                                <div class="mb-2">
                                    <span class="inline-block px-2 py-1 text-xs bg-purple-600 text-white rounded">Article</span>
                                </div>
                            ` : ''}
                            ${title ? `
                                <h3 class="text-lg font-bold text-white mb-2">${title}</h3>
                            ` : ''}
                            <div class="text-xs text-slate-400 mb-3">
                                ${formatDate(post.created_at)}
                            </div>
                            <div class="text-slate-100 text-sm whitespace-pre-wrap break-words flex-1 line-clamp-6">
                                ${formattedText}
                            </div>
                            ${postLink ? `
                                <div class="mt-3">
                                    <a href="${postLink}" target="_blank" class="text-blue-400 hover:underline text-sm">
                                        ${isArticle ? 'Read full article' : 'View post'} â†’
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateLoadMoreVisibility() {
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            // Hide load more button since we're using infinite scroll
            loadMoreContainer.classList.add('hidden');
        }

        function loadMorePosts() {
            const currentLength = displayedPosts.length;
            
            // If we've shown all posts, loop back to the beginning
            if (currentLength >= allPosts.length) {
                displayedPosts = allPosts.slice(0, POSTS_PER_PAGE);
            } else {
                const nextBatch = allPosts.slice(0, currentLength + POSTS_PER_PAGE);
                displayedPosts = nextBatch;
            }
            
            renderPosts();
            updateLastUpdate();
        }

        /* -------------------------
         * Fetch posts
         * ------------------------- */
        async function fetchPosts() {
            if (!hexPubkey) return;

            const refreshIcon = document.getElementById('refreshIcon');
            const errorDiv    = document.getElementById('error');

            refreshIcon.classList.add('animate-spin');
            errorDiv.classList.add('hidden');
            allPosts = [];
            allArticles = [];
            displayedPosts = [];

            startLoadingBar();
            console.log('ðŸ“¡ Fetching posts and articles from relays...');

            try {
                // Fetch regular posts (kind 1)
                const events = await pool.querySync(RELAYS, {
                    authors: [hexPubkey],
                    kinds: [1],
                    limit: 500
                });

                console.log(`âœ“ Received ${events.length} total posts`);

                const filtered = filterPostsByHashtag(events);
                console.log(`âœ“ Filtered to ${filtered.length} #hackerspace / #boneohackerspace posts with images`);

                // Fetch long-form articles (kind 30023)
                const articles = await pool.querySync(RELAYS, {
                    authors: [hexPubkey],
                    kinds: [30023],
                    limit: 100
                });

                console.log(`âœ“ Received ${articles.length} total articles`);

                const filteredArticles = filterArticlesByHashtag(articles);
                console.log(`âœ“ Filtered to ${filteredArticles.length} #hackerspace / #boneohackerspace articles with images`);

                // Combine posts and articles
                allArticles = filteredArticles;
                const combined = [...filtered, ...filteredArticles];
                combined.sort((a, b) => b.created_at - a.created_at);

                allPosts = combined;
                displayedPosts = allPosts.slice(0, POSTS_PER_PAGE);

                renderPosts();
                updateLoadMoreVisibility();
                updateLastUpdate();
            } catch (err) {
                console.error('Error fetching posts:', err);
                errorDiv.textContent = 'Failed to load posts.';
                errorDiv.classList.remove('hidden');
            } finally {
                refreshIcon.classList.remove('animate-spin');
                finishLoadingBar();
            }
        }

        /* -------------------------
         * Event listeners
         * ------------------------- */
        document.getElementById('refreshBtn').addEventListener('click', fetchPosts);

        document.getElementById('loadMoreBtn').addEventListener('click', () => {
            loadMorePosts();
        });

        // Infinite scroll
        let isLoadingMore = false;
        window.addEventListener('scroll', () => {
            if (isLoadingMore) return;
            
            const scrollHeight = document.documentElement.scrollHeight;
            const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            const clientHeight = document.documentElement.clientHeight;
            
            // Load more when user scrolls to bottom (with 200px threshold)
            if (scrollTop + clientHeight >= scrollHeight - 200) {
                isLoadingMore = true;
                loadMorePosts();
                setTimeout(() => {
                    isLoadingMore = false;
                }, 500);
            }
        });

        // Scroll to top button
        const scrollToTopBtn = document.getElementById('scrollToTop');
        
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                scrollToTopBtn.classList.remove('opacity-0', 'pointer-events-none');
                scrollToTopBtn.classList.add('opacity-100');
            } else {
                scrollToTopBtn.classList.add('opacity-0', 'pointer-events-none');
                scrollToTopBtn.classList.remove('opacity-100');
            }
        });

        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // Initial fetch + auto-refresh
        if (hexPubkey) {
            fetchPosts();
            setInterval(fetchPosts, 60000);
        }
    </script>
</body>
</html>
