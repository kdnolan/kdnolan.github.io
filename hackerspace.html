<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HackerSpace Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #0f172a, #581c87, #0f172a);
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto p-6">
        <div class="bg-slate-800/50 backdrop-blur-sm rounded-lg shadow-2xl p-8 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-4xl font-bold text-white mb-2">HackerSpace</h1>
                    <p class="text-slate-300">Posts by kman2140</p>
                </div>
                <button id="refreshBtn" class="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <svg id="refreshIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
            <p id="lastUpdate" class="text-sm text-slate-400"></p>
        </div>

        <div id="error" class="hidden bg-red-900/50 border border-red-600 text-red-200 rounded-lg p-4 mb-6"></div>
        
        <div id="loading" class="text-center text-slate-300 py-12">
            <svg class="w-12 h-12 animate-spin mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Loading posts...
        </div>

        <div id="noPosts" class="hidden text-center text-slate-400 py-12">
            No posts found with #hackerspace or #boneohackerspace
        </div>

        <div id="posts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        
        <div id="loadMoreContainer" class="hidden mt-8 text-center">
            <button id="loadMoreBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-lg transition-colors font-semibold">
                Load More Posts
            </button>
        </div>
    </div>

    <script type="module">
        import { SimplePool, nip19 } from 'https://esm.sh/nostr-tools@2.10.2';

        const RELAYS = [
            'wss://relay.damus.io',
            'wss://relay.nostr.band',
            'wss://nos.lol',
            'wss://relay.primal.net',
            'wss://nostr.wine',
            'wss://relay.snort.social'
        ];

        const NPUB = 'npub1cyla8qgt9gv8y6ydv8s2prt89h8afc0sr2kaz64ryjmlpdrzxm4qwlh53q';

        let pool = new SimplePool();
        let allPosts = [];
        let displayedPosts = [];
        let hexPubkey;
        const POSTS_PER_PAGE = 9;

        try {
            const decoded = nip19.decode(NPUB);
            hexPubkey = decoded.data;
            console.log('âœ“ Converted npub to hex:', hexPubkey);
        } catch (e) {
            console.error('Failed to decode npub:', e);
            document.getElementById('error').textContent = 'Error: Invalid npub format';
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        function formatDate(timestamp) {
            return new Date(timestamp * 1000).toLocaleString();
        }

        function extractImages(content) {
            const imageRegex = /(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp))/gi;
            return content.match(imageRegex) || [];
        }

        function formatContent(content) {
            // Remove image URLs from text since we'll display them separately
            let text = content.replace(/(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp))/gi, '');
            
            return text
                .replace(/https?:\/\/[^\s]+/g, url => `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline break-all">${url}</a>`)
                .replace(/#\w+/g, tag => `<span class="text-purple-400">${tag}</span>`)
                .replace(/\n/g, '<br>');
        }

        function filterPostsByHashtag(posts) {
            return posts.filter(post => {
                const content = post.content.toLowerCase();
                // Match various formats of the hashtags
                return content.includes('hackerspace') || 
                       content.includes('boneohackerspace') ||
                       content.includes('#hackerspace') || 
                       content.includes('#boneohackerspace');
            });
        }

        function displayPosts() {
            const postsContainer = document.getElementById('posts');
            const loadingDiv = document.getElementById('loading');
            const noPostsDiv = document.getElementById('noPosts');
            const loadMoreContainer = document.getElementById('loadMoreContainer');

            loadingDiv.classList.add('hidden');

            if (allPosts.length === 0) {
                noPostsDiv.classList.remove('hidden');
                loadMoreContainer.classList.add('hidden');
                return;
            }

            noPostsDiv.classList.add('hidden');
            
            // Show only the first batch of posts
            displayedPosts = allPosts.slice(0, POSTS_PER_PAGE);
            
            postsContainer.innerHTML = displayedPosts.map(post => {
                const images = extractImages(post.content);
                const formattedText = formatContent(post.content);
                
                return `
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow flex flex-col">
                        ${images.length > 0 ? `
                            <div class="relative w-full aspect-square bg-slate-900">
                                <img src="${images[0]}" alt="Post image" class="w-full h-full object-cover" 
                                     onerror="this.parentElement.style.display='none'">
                            </div>
                        ` : ''}
                        <div class="p-4 flex-1 flex flex-col">
                            <div class="text-xs text-slate-400 mb-3">
                                ${formatDate(post.created_at)}
                            </div>
                            <div class="text-slate-100 text-sm whitespace-pre-wrap break-words flex-1">
                                ${formattedText}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Show or hide load more button
            if (allPosts.length > displayedPosts.length) {
                loadMoreContainer.classList.remove('hidden');
            } else {
                loadMoreContainer.classList.add('hidden');
            }

            document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()} - Showing ${displayedPosts.length} of ${allPosts.length} posts`;
        }

        async function fetchPosts() {
            if (!hexPubkey) {
                return;
            }

            const refreshIcon = document.getElementById('refreshIcon');
            const errorDiv = document.getElementById('error');
            
            refreshIcon.classList.add('animate-spin');
            errorDiv.classList.add('hidden');
            allPosts = [];

            console.log('ðŸ“¡ Fetching posts from relays...');

            try {
                const events = await pool.querySync(RELAYS, {
                    authors: [hexPubkey],
                    kinds: [1],
                    limit: 500
                });

                console.log(`âœ“ Received ${events.length} total posts`);

                // Filter posts by hashtag
                const filteredPosts = filterPostsByHashtag(events);
                console.log(`âœ“ Filtered to ${filteredPosts.length} posts with #hackerspace or #boneohackerspace`);

                // Sort by timestamp (newest first)
                allPosts = filteredPosts.sort((a, b) => b.created_at - a.created_at);

                if (allPosts.length === 0) {
                    errorDiv.textContent = 'No posts found with #hackerspace or #boneohackerspace tags.';
                    errorDiv.classList.remove('hidden');
                }

                displayPosts();
            } catch (err) {
                console.error('Error fetching posts:', err);
                errorDiv.textContent = `Error loading posts: ${err.message}`;
                errorDiv.classList.remove('hidden');
            } finally {
                refreshIcon.classList.remove('animate-spin');
            }
        }

        document.getElementById('refreshBtn').addEventListener('click', fetchPosts);
        
        document.getElementById('loadMoreBtn').addEventListener('click', () => {
            const currentLength = displayedPosts.length;
            const nextBatch = allPosts.slice(0, currentLength + POSTS_PER_PAGE);
            displayedPosts = nextBatch;
            
            const postsContainer = document.getElementById('posts');
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            
            postsContainer.innerHTML = displayedPosts.map(post => {
                const images = extractImages(post.content);
                const formattedText = formatContent(post.content);
                
                return `
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow flex flex-col">
                        ${images.length > 0 ? `
                            <div class="relative w-full aspect-square bg-slate-900">
                                <img src="${images[0]}" alt="Post image" class="w-full h-full object-cover" 
                                     onerror="this.parentElement.style.display='none'">
                            </div>
                        ` : ''}
                        <div class="p-4 flex-1 flex flex-col">
                            <div class="text-xs text-slate-400 mb-3">
                                ${formatDate(post.created_at)}
                            </div>
                            <div class="text-slate-100 text-sm whitespace-pre-wrap break-words flex-1">
                                ${formattedText}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Hide button if all posts are shown
            if (displayedPosts.length >= allPosts.length) {
                loadMoreContainer.classList.add('hidden');
            }
            
            document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()} - Showing ${displayedPosts.length} of ${allPosts.length} posts`;
        });

        // Initial fetch
        if (hexPubkey) {
            fetchPosts();
            // Auto-refresh every 60 seconds
            setInterval(fetchPosts, 60000);
        }
    </script>
</body>
</html>