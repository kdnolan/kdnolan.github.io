<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>kman2140</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="https://github.com/kdnolan/kdnolan.github.io/blob/master/avatars/lasereyes2.png?raw=true" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/nostr-tools@2.1.3/lib/nostr.bundle.js"></script>

  <style>
    html, body { margin: 0; height: 100%; background: #000; }

    .selectable {
      position: fixed; left: 50%; top: 46%; transform: translate(-50%, -50%);
      max-width: min(1000px, 92vw); padding: 12px 14px; border-radius: 14px;
      background: transparent; color: white;
      font: 700 clamp(14px, 2.8vw, 22px) / 1.25 ui-monospace, monospace;
      white-space: normal; overflow-wrap: anywhere; word-break: break-word;
      text-align: center;
      text-shadow: 0 0 10px rgba(138, 43, 226, 0.95), 0 0 22px rgba(138, 43, 226, 0.8), 0 0 34px rgba(138, 43, 226, 0.55);
      user-select: text; -webkit-user-select: text; pointer-events: auto; z-index: 10;
    }

    .hint, .toast {
      position: fixed; left: 12px; right: 12px; padding: 10px 12px;
      border-radius: 10px; background: rgba(0,0,0,0.55); color: #fff;
      font: 14px system-ui, sans-serif; z-index: 11; max-width: 640px;
    }
    .hint { bottom: calc(12px + env(safe-area-inset-bottom)); }
    .toast { bottom: calc(56px + env(safe-area-inset-bottom)); opacity: 0; transition: opacity .25s ease; pointer-events: none; }
    textarea#copyFallback { position: fixed; left: -9999px; top: -9999px; }

    @media (max-width: 520px) {
      .selectable { top: 44%; max-width: 94vw; padding: 10px 12px; font-size: clamp(12px, 4.2vw, 16px); line-height: 1.22; }
    }

    .chat-widget-btn {
      position: fixed; top: 24px; right: 24px; z-index: 1000;
      width: 56px; height: 56px; border-radius: 50%;
      background: #8A2BE2; color: white; border: none; cursor: pointer;
      box-shadow: 0 4px 20px rgba(138, 43, 226, 0.4);
      display: flex; align-items: center; justify-content: center;
      transition: all 0.3s ease; animation: pulse-chat 2s ease-in-out infinite;
    }
    .chat-widget-btn:hover { transform: scale(1.1); box-shadow: 0 4px 30px rgba(138, 43, 226, 0.6); }
    .chat-widget-btn svg { width: 24px; height: 24px; }
    
    @keyframes pulse-chat {
      0%, 100% { box-shadow: 0 4px 20px rgba(138, 43, 226, 0.4); }
      50% { box-shadow: 0 4px 30px rgba(138, 43, 226, 0.6), 0 0 40px rgba(138, 43, 226, 0.3); }
    }
    
    .chat-widget-window {
      position: fixed; top: 24px; right: 24px; z-index: 1001;
      width: 380px; max-width: calc(100vw - 2rem);
      height: 580px; max-height: calc(100vh - 3rem);
      background: #111827; border-radius: 16px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      border: 1px solid #374151; display: none; flex-direction: column; overflow: hidden;
    }
    .chat-widget-window.open { display: flex; animation: slideUp 0.3s ease; }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .chat-header {
      padding: 16px; border-bottom: 1px solid #374151;
      display: flex; align-items: center; gap: 12px;
      background: rgba(17, 24, 39, 0.95);
    }
    .chat-header-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(138, 43, 226, 0.5); }
    .chat-header-info { flex: 1; }
    .chat-header-name { font-weight: 600; color: white; margin: 0; font-size: 14px; }
    .chat-header-status { font-size: 12px; color: #9CA3AF; display: flex; align-items: center; gap: 4px; }
    .chat-close-btn { background: none; border: none; color: #9CA3AF; cursor: pointer; padding: 8px; border-radius: 8px; transition: all 0.2s; }
    .chat-close-btn:hover { background: #374151; color: white; }
    
    .chat-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .chat-message { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
    .chat-message.sent { align-self: flex-end; background: #8A2BE2; color: white; border-bottom-right-radius: 4px; }
    .chat-message.received { align-self: flex-start; background: #374151; color: white; border-bottom-left-radius: 4px; }
    .chat-message.system { align-self: center; background: rgba(138, 43, 226, 0.2); color: #A78BFA; font-size: 12px; padding: 8px 12px; border-radius: 8px; max-width: 90%; text-align: center; }
    
    .chat-login-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; text-align: center; }
    .chat-icon-circle { width: 64px; height: 64px; border-radius: 50%; background: rgba(138, 43, 226, 0.2); display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
    .chat-icon-circle svg { width: 32px; height: 32px; color: #A78BFA; }
    .chat-login-screen h4 { color: white; margin: 0 0 8px 0; font-size: 18px; }
    .chat-login-screen p { color: #9CA3AF; margin: 0 0 20px 0; font-size: 14px; line-height: 1.5; }
    
    .chat-login-btn { background: #8A2BE2; color: white; border: none; padding: 12px 24px; border-radius: 9999px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 14px; width: 100%; margin-bottom: 12px; }
    .chat-login-btn:hover { background: #7C3AED; }
    .chat-login-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .chat-divider { display: flex; align-items: center; gap: 12px; margin: 16px 0; color: #6B7280; font-size: 12px; }
    .chat-divider::before, .chat-divider::after { content: ''; flex: 1; height: 1px; background: #374151; }
    .chat-nsec-input { width: 100%; padding: 10px 14px; background: #1F2937; border: 1px solid #374151; border-radius: 8px; color: white; font-size: 14px; margin-bottom: 12px; font-family: ui-monospace, monospace; }
    .chat-nsec-input::placeholder { color: #6B7280; }
    .chat-nsec-input:focus { outline: none; border-color: #8A2BE2; }
    
    .chat-input-area { padding: 16px; border-top: 1px solid #374151; background: rgba(17, 24, 39, 0.95); }
    .chat-input-container { display: flex; gap: 8px; }
    .chat-input { flex: 1; padding: 10px 14px; background: #1F2937; border: 1px solid #374151; border-radius: 9999px; color: white; font-size: 14px; }
    .chat-input::placeholder { color: #6B7280; }
    .chat-input:focus { outline: none; border-color: #8A2BE2; }
    .chat-send-btn { width: 40px; height: 40px; border-radius: 50%; background: #8A2BE2; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .chat-send-btn:hover { background: #7C3AED; transform: scale(1.05); }
    .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .chat-send-btn svg { width: 18px; height: 18px; }
    .chat-error { padding: 10px 14px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #FCA5A5; font-size: 13px; margin-bottom: 12px; text-align: left; }
    .hidden { display: none !important; }
  </style>

  <script>
    const NPUB = "npub1cyla8qgt9gv8y6ydv8s2prt89h8afc0sr2kaz64ryjmlpdrzxm4qwlh53q";
    const RECIPIENT_PUBKEY = "c27e0e1025bb0e89cb06d86b586fa66f225af62a7d2ad9cf9f82c904daea9cda";

    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.opacity = "1";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => (t.style.opacity = "0"), 1400);
    }

    async function copyText(text) {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch {}
      try {
        const ta = document.getElementById("copyFallback");
        ta.value = text;
        ta.select();
        return document.execCommand("copy");
      } catch {}
      return false;
    }

    AFRAME.registerComponent("auto-cursor", {
      init: function () {
        const scene = this.el;
        const cam = scene.querySelector("[camera]");
        if (!cam) return;
        if (!AFRAME.utils.device.isMobile()) {
          const cur = document.createElement("a-entity");
          cur.setAttribute("cursor", "rayOrigin: mouse; fuse: false");
          cur.setAttribute("raycaster", "objects: .clickable");
          scene.appendChild(cur);
        } else {
          const gaze = document.createElement("a-entity");
          gaze.className = "gaze-cursor";
          gaze.setAttribute("cursor", "fuse: true; fuseTimeout: 700");
          gaze.setAttribute("position", "0 0 -1");
          gaze.setAttribute("geometry", "primitive: ring; radiusInner: 0.012; radiusOuter: 0.02");
          gaze.setAttribute("material", "shader: flat; color: white; opacity: 0.95");
          gaze.setAttribute("raycaster", "objects: .clickable");
          cam.appendChild(gaze);
        }
      }
    });

    AFRAME.registerComponent("parallax-sky", {
      schema: { yawFactor: {type: "number", default: 0.06} },
      init: function () {
        this.cam = this.el.sceneEl.querySelector("[camera]");
        this.baseRot = this.el.object3D.rotation.clone();
      },
      tick: function () {
        if (!this.cam) return;
        const yaw = this.cam.object3D.rotation.y;
        this.el.object3D.rotation.y = this.baseRot.y + (-yaw * this.data.yawFactor);
      }
    });

    AFRAME.registerComponent("parallax-avatar", {
      schema: { factor: {type: "number", default: 0.18}, maxShift: {type: "number", default: 0.35} },
      init: function () {
        this.camRig = this.el.sceneEl.querySelector("#camRig");
        this.basePos = this.el.object3D.position.clone();
      },
      tick: function () {
        if (!this.camRig) return;
        const p = this.camRig.object3D.position;
        const sx = THREE.MathUtils.clamp(-p.x * this.data.factor, -this.data.maxShift, this.data.maxShift);
        const sz = THREE.MathUtils.clamp(-p.z * this.data.factor, -this.data.maxShift, this.data.maxShift);
        this.el.object3D.position.x = this.basePos.x + sx;
        this.el.object3D.position.z = this.basePos.z + sz;
      }
    });

    let userPrivateKey = null;
    let userPublicKey = null;
    const DEFAULT_RELAYS = ['wss://relay.damus.io', 'wss://relay.nostr.band', 'wss://nos.lol'];

    function addMessage(text, type = 'system') {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${type}`;
      messageDiv.textContent = text;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function loginWithExtension() {
      const errorEl = document.getElementById('chatError');
      errorEl.classList.add('hidden');
      try {
        if (!window.nostr) {
          throw new Error('No Nostr extension found. Please install nos2x, Alby, or another Nostr extension.');
        }
        userPublicKey = await window.nostr.getPublicKey();
        document.getElementById('chatLoginScreen').classList.add('hidden');
        document.getElementById('chatMessagesScreen').classList.remove('hidden');
        addMessage('Connected! Send your first encrypted message.', 'system');
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.classList.remove('hidden');
      }
    }

    async function loginWithNsec() {
      const errorEl = document.getElementById('chatError');
      const nsecInput = document.getElementById('nsecInput');
      const nsec = nsecInput.value.trim();
      errorEl.classList.add('hidden');
      if (!nsec) {
        errorEl.textContent = 'Please enter your nsec key';
        errorEl.classList.remove('hidden');
        return;
      }
      try {
        const decoded = NostrTools.nip19.decode(nsec);
        if (decoded.type !== 'nsec') throw new Error('Invalid nsec format');
        userPrivateKey = decoded.data;
        userPublicKey = NostrTools.getPublicKey(userPrivateKey);
        document.getElementById('chatLoginScreen').classList.add('hidden');
        document.getElementById('chatMessagesScreen').classList.remove('hidden');
        addMessage('Connected! Send your first encrypted message.', 'system');
      } catch (err) {
        errorEl.textContent = 'Invalid nsec key. Please check and try again.';
        errorEl.classList.remove('hidden');
      }
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const sendBtn = document.getElementById('chatSendBtn');
      const message = input.value.trim();
      if (!message) return;
      sendBtn.disabled = true;
      input.disabled = true;
      try {
        let encryptedContent;
        if (window.nostr && !userPrivateKey) {
          encryptedContent = await window.nostr.nip04.encrypt(RECIPIENT_PUBKEY, message);
        } else {
          encryptedContent = await NostrTools.nip04.encrypt(userPrivateKey, RECIPIENT_PUBKEY, message);
        }
        const event = {
          kind: 4,
          created_at: Math.floor(Date.now() / 1000),
          tags: [['p', RECIPIENT_PUBKEY]],
          content: encryptedContent,
          pubkey: userPublicKey
        };
        let signedEvent;
        if (window.nostr && !userPrivateKey) {
          signedEvent = await window.nostr.signEvent(event);
        } else {
          event.id = NostrTools.getEventHash(event);
          event.sig = NostrTools.signEvent(event, userPrivateKey);
          signedEvent = event;
        }
        const relay = NostrTools.relayInit(DEFAULT_RELAYS[0]);
        await relay.connect();
        await relay.publish(signedEvent);
        relay.close();
        addMessage(message, 'sent');
        input.value = '';
      } catch (err) {
        addMessage('Failed to send: ' + err.message, 'system');
      }
      sendBtn.disabled = false;
      input.disabled = false;
      input.focus();
    }

    window.addEventListener("DOMContentLoaded", () => {
      const overlay = document.getElementById("npubOverlay");
      overlay.textContent = NPUB;
      overlay.onclick = async () => {
        const ok = await copyText(NPUB);
        showToast(ok ? "Copied npub" : "Copy blocked");
      };
      const chatBtn = document.getElementById('chatWidgetBtn');
      const chatWindow = document.getElementById('chatWidgetWindow');
      const chatCloseBtn = document.getElementById('chatCloseBtn');
      chatBtn.addEventListener('click', () => {
        chatWindow.classList.add('open');
        chatBtn.style.display = 'none';
      });
      chatCloseBtn.addEventListener('click', () => {
        chatWindow.classList.remove('open');
        chatBtn.style.display = 'flex';
      });
      document.getElementById('extensionLoginBtn').addEventListener('click', loginWithExtension);
      document.getElementById('nsecLoginBtn').addEventListener('click', loginWithNsec);
      document.getElementById('chatSendBtn').addEventListener('click', sendMessage);
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    });
  </script>
</head>
<body>
  <textarea id="copyFallback"></textarea>
  <div id="npubOverlay" class="selectable" title="Tap/click to copy, or drag to highlight"></div>
  <div id="toast" class="toast"></div>
  <div class="hint">Desktop: WASD + mouse ¬∑ Mobile: drag to look ¬∑ Tap NPUB to copy</div>

  <button class="chat-widget-btn" id="chatWidgetBtn" title="Send a private message">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
    </svg>
  </button>

  <div class="chat-widget-window" id="chatWidgetWindow">
    <div class="chat-header">
      <img src="https://raw.githubusercontent.com/kdnolan/kdnolan.github.io/master/avatars/lasereyes.jpeg" alt="kman2140" class="chat-header-avatar">
      <div class="chat-header-info">
        <p class="chat-header-name">kman2140</p>
        <span class="chat-header-status">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
          </svg>
          Private & Encrypted
        </span>
      </div>
      <button class="chat-close-btn" id="chatCloseBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="chat-body">
      <div id="chatLoginScreen" class="chat-login-screen">
        <div class="chat-icon-circle">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
        </div>
        <h4>Send Encrypted DM</h4>
        <p>Connect with your Nostr identity to send me a private, encrypted message.</p>
        <div id="chatError" class="chat-error hidden"></div>
        <button class="chat-login-btn" id="extensionLoginBtn">üîê Sign in with Extension</button>
        <div class="chat-divider">or</div>
        <input type="password" class="chat-nsec-input" id="nsecInput" placeholder="Paste your nsec key..." />
        <button class="chat-login-btn" id="nsecLoginBtn">üîë Sign in with nsec</button>
      </div>
      <div id="chatMessagesScreen" class="hidden" style="flex: 1; display: flex; flex-direction: column;">
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-area">
          <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." />
            <button class="chat-send-btn" id="chatSendBtn">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <a-scene auto-cursor renderer="colorManagement: true; pixelRatio: devicePixelRatio">
    <a-assets>
      <img id="city" crossorigin="anonymous" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/city.jpg" />
      <img id="laser" crossorigin="anonymous" src="https://raw.githubusercontent.com/kdnolan/kdnolan.github.io/master/avatars/lasereyes.jpeg" />
    </a-assets>
    <a-entity id="camRig" position="0 1.6 0">
      <a-camera wasd-controls="acceleration: 18"></a-camera>
    </a-entity>
    <a-sky src="#city" rotation="0 -90 0" parallax-sky="yawFactor: 0.06"></a-sky>
    <a-entity parallax-avatar="factor: 0.18; maxShift: 0.35" position="0 1.68 -4.0" look-at="[camera]" animation="property: position; dir: alternate; dur: 4200; easing: easeInOutSine; loop: true; to: 0 1.92 -4.0">
      <a-entity geometry="primitive: circle; radius: 0.95" position="0 0 -0.03" material="shader: flat; color: #8A2BE2; opacity: 0.14; transparent: true; side: double"></a-entity>
      <a-entity geometry="primitive: circle; radius: 0.82" material="shader: flat; src: #laser; opacity: 0.98; transparent: true; side: double"></a-entity>
    </a-entity>
    <a-entity light="type: ambient; intensity: 0.9"></a-entity>
  </a-scene>
</body>
</html>